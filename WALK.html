<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>歩数</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1, h2, h3 {
      color: #333;
    }
    form {
      margin-bottom: 20px;
    }
    input[type="number"],
    input[type="submit"],
    button {
      padding: 5px;
      font-size: 16px;
      margin-right: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
    .simulation {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #aaa;
      background-color: #f9f9f9;
    }
    .milestoneTable {
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h1>歩数記録システム</h1>

  <form id="stepForm">
    <label for="steps">現在の歩数:</label>
    <input type="number" id="steps" name="steps" min="0" required>
    <input type="submit" value="記録">
    <button type="button" id="resetButton">リセット</button>
  </form>

  <div class="simulation">
    <h2>シミュレーション結果</h2>
    <p id="rateDisplay">1分あたりの増加歩数: N/A</p>
    <p id="estimateDisplay">10000歩到達推定時刻: N/A</p>
    <div id="milestoneDisplay">
      <!-- 未到達の1000歩単位ごとの到達予想を表示 -->
    </div>
  </div>

  <h2>記録ログ</h2>
  <table id="logTable">
    <thead>
      <tr>
        <th>記録時刻</th>
        <th>歩数</th>
        <th>前回との差（分）</th>
        <th>1分あたりの増加</th>
      </tr>
    </thead>
    <tbody>
      <!-- ログ行が追加されます -->
    </tbody>
  </table>

  <script>
    // ログの配列（各要素は { time: ISOString, steps: number }）
    let logs = [];

    // HTML要素の取得
    const form = document.getElementById('stepForm');
    const stepsInput = document.getElementById('steps');
    const resetButton = document.getElementById('resetButton');
    const logTableBody = document.querySelector('#logTable tbody');
    const rateDisplay = document.getElementById('rateDisplay');
    const estimateDisplay = document.getElementById('estimateDisplay');
    const milestoneDisplay = document.getElementById('milestoneDisplay');

    // ローカルストレージからログを読み込み（あれば）
    function loadLogs() {
      const storedLogs = localStorage.getItem('stepLogs');
      if (storedLogs) {
        try {
          logs = JSON.parse(storedLogs).map(item => {
            // timeはDate型に変換
            return { time: new Date(item.time), steps: item.steps };
          });
        } catch(e) {
          logs = [];
        }
      }
    }

    // ローカルストレージへログを保存
    function saveLogs() {
      // DateはISO文字列に変換して保存
      const logsToStore = logs.map(item => ({ time: item.time.toISOString(), steps: item.steps }));
      localStorage.setItem('stepLogs', JSON.stringify(logsToStore));
    }

    // ログテーブルとシミュレーションの更新
    function updateDisplays() {
      updateLogTable();
      updateSimulation();
    }

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const steps = parseInt(stepsInput.value, 10);
      const currentTime = new Date();
      const newLog = { time: currentTime, steps: steps };
      logs.push(newLog);
      saveLogs();
      updateDisplays();
      stepsInput.value = '';
    });

    // リセットボタン：ログとローカルストレージをクリア
    resetButton.addEventListener('click', function() {
      if (confirm("全てのログをリセットしますか？")) {
        logs = [];
        localStorage.removeItem('stepLogs');
        updateDisplays();
      }
    });

    function updateLogTable() {
      logTableBody.innerHTML = '';
      // 最新ログを最上部に表示するため逆順にループ
      for (let i = logs.length - 1; i >= 0; i--) {
        const log = logs[i];
        const row = document.createElement('tr');

        // 記録時刻
        const timeCell = document.createElement('td');
        timeCell.textContent = log.time.toLocaleTimeString();
        row.appendChild(timeCell);

        // 歩数
        const stepsCell = document.createElement('td');
        stepsCell.textContent = log.steps;
        row.appendChild(stepsCell);

        // 前回との差（分）と1分あたりの増加を計算
        let diffTime = 'N/A';
        let ratePerMinute = 'N/A';
        if (i < logs.length - 1) {
          const nextLog = logs[i + 1];
          const diffMs = nextLog.time - log.time;
          const diffMinutes = diffMs / 60000;
          diffTime = diffMinutes.toFixed(2);
          if (diffMinutes > 0) {
            ratePerMinute = ((nextLog.steps - log.steps) / diffMinutes).toFixed(2);
          }
        }
        const diffCell = document.createElement('td');
        diffCell.textContent = diffTime;
        row.appendChild(diffCell);

        const rateCell = document.createElement('td');
        rateCell.textContent = ratePerMinute;
        row.appendChild(rateCell);

        logTableBody.appendChild(row);
      }
    }

    function updateSimulation() {
      if (logs.length < 2) {
        rateDisplay.textContent = "1分あたりの増加歩数: N/A (ログを2回以上記録してください)";
        estimateDisplay.textContent = "10000歩到達推定時刻: N/A";
        milestoneDisplay.innerHTML = "";
        return;
      }

      // 最初と最新のログを利用
      const firstLog = logs[0];
      const latestLog = logs[logs.length - 1];

      const totalDiffMs = latestLog.time - firstLog.time;
      const totalMinutes = totalDiffMs / 60000;
      const totalStepsGained = latestLog.steps - firstLog.steps;

      let avgRate = 0;
      if (totalMinutes > 0) {
        avgRate = totalStepsGained / totalMinutes;
      }
      rateDisplay.textContent = "1分あたりの増加歩数: " + avgRate.toFixed(2);

      // 10000歩到達の予想
      const remainingSteps = 10000 - latestLog.steps;
      let estimatedMinutesFor10000 = avgRate > 0 ? remainingSteps / avgRate : 0;
      const estimatedTime10000 = new Date(latestLog.time.getTime() + estimatedMinutesFor10000 * 60000);
      const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
      const estimatedTimeString = estimatedTime10000.toLocaleTimeString([], options);
      estimateDisplay.textContent = "10000歩到達推定時刻: " + estimatedTimeString + "（約" + estimatedMinutesFor10000.toFixed(2) + "分後）";

      // 1000歩単位ごとの到達予想
      let nextMilestone = Math.ceil(latestLog.steps / 1000) * 1000;
      if (nextMilestone < latestLog.steps) {
        nextMilestone += 1000;
      }
      let milestoneHTML = "<h3>各1000歩ごとの到達予想</h3>";
      milestoneHTML += "<table class='milestoneTable'><thead><tr><th>目標歩数</th><th>予想到達時刻</th><th>残り分数</th></tr></thead><tbody>";
      for (let milestone = nextMilestone; milestone <= 10000; milestone += 1000) {
        const stepsNeeded = milestone - latestLog.steps;
        let minutesNeeded = avgRate > 0 ? stepsNeeded / avgRate : 0;
        const predictedTime = new Date(latestLog.time.getTime() + minutesNeeded * 60000);
        const predictedTimeString = predictedTime.toLocaleTimeString([], options) + "（約" + minutesNeeded.toFixed(2) + "分後）";
        milestoneHTML += "<tr><td>" + milestone + "歩</td><td>" + predictedTimeString + "</td><td>" + minutesNeeded.toFixed(2) + "</td></tr>";
      }
      milestoneHTML += "</tbody></table>";
      milestoneDisplay.innerHTML = milestoneHTML;
    }

    // 初回ロード時にログを読み込み・表示
    loadLogs();
    updateDisplays();
  </script>
</body>
</html>
